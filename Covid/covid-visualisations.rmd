---
title: "Covid Visualisations"
author: "Paul Williams"
date: '2022-04-05'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Learning to Visualise in R using Covid data

I've started this project so I can learn more about visualizing data in R using
ggplot, ggmap, and other Grammar of Graphics based tools.

## Data source

Data download link: https://covid.ourworldindata.org/data/owid-covid-data.csv

The data used has been sourced from https://ourworldindata.org. A download l1ink
and list of their data sources is available via the README.md of this Github
project https://github.com/owid/covid-19-data/tree/master/public/data. The
README.md also lists the metadata, i.e. descriptions of variables and other
links for understanding the data and how it was collected.

The visualizations and insights presented or mentioned in this project are only
as reliable as the underlying data and my relatively apprentice level ability.

## Dependencies

I currently prefer to specify my dependencies upfront so they're installed
and ready to go. As I'm fairly new to the field my best strategy is to follow
industry norms, practices, and tools such as `tidyverse` until I'm ready to
start breaking the rules and flouting conventions for better results. However,
as a seasoned software engineer I will use my own judgement and preference for
writing readable and iconic code.

```{r packages}
install.packages("tidyverse")
install.packages("lubridate")
install.packages("zoo")
install.packages("ggplot2")
#install.packages("ggmap")
#install.packages("maps")
#install.packages("viridis")

library("tidyverse")
```

## Constants and utility functions

Here I am just defining constants and utility functions to aid readability
and avoid unnecessarily repeating myself.

```{r utility-functions}

ONE_NANO <- 1e-9
ONE_HUNDRED_MICRO <- 1e-5

ONE_HUNDRED_THOUSAND <- 1e5
ONE_MILLION <- 1e6
ONE_HUNDRED_MILLION <- 1e8
ONE_BILLION <- 1e9

thin_line_style = element_line(colour = "gray", size = 0.2)

apply_data_types <- function(data) {
  r <- data %>%
    mutate(
      total_cases = as.integer(total_cases),
    )
  
  return (r)
}

# save_plot saves the last plot creating the required parent directories if
# they currently don't exist
save_plot <- function(filename) {
  dir <- "./plots"
 
  if (!file.exists(dir)) {
    dir.create(dir, mode = "0744")
  }
  
  path <- paste(dir, filename, sep = "/")
  ggsave(path)
}

apply_project_theme <- function() {
  
  t <- theme_classic() +
    theme(
      # Remove axis lines
      axis.line = element_blank(),
      axis.ticks = element_blank(),
      
      # Minimal lines on Y axis
      panel.grid.major.y = thin_line_style,
      
      # Remove legend
      legend.position="none",
      
      # Center titles & captions
      plot.title = element_text(hjust = 0.5),
      plot.subtitle = element_text(hjust = 0.5),
      plot.caption = element_text(hjust = 0.5),
    )
  
  return (t)
}

remove_x_axis_theme = function() {
  r <- theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.line.x = element_blank(),
  )

  return (r)
}

# get_distinct_col identifies all unique values in a specific column
get_distinct_col <- function(data, col, include_na=FALSE) {
  col_sym <- rlang::sym(col)
  
  if (include_na) {
    r <- data
  } else {
    r <- filter(data, !is.na(!!col_sym))
  }
  
  r <- r %>%
    select(!!col_sym) %>%
    distinct(!!col_sym) %>%
    arrange(!!col_sym)
  
  return (r)
}

# get_geo_metadata extracts metadata about geographic locations from the data
get_geo_metadata <- function(data) {
  r <- data %>%
    group_by(continent, location, iso_code) %>%
    distinct(location) %>%
    summarise(
      continent,
      location,
      iso_code,
    ) %>%
    ungroup() %>%
    arrange(location)
  
  return (r)
}

get_all_continents <- function(data) {
  return (get_distinct_col(data, 'continent'))
}

get_all_locations <- function(data) {
  return (get_distinct_col(data, 'location'))
}

get_all_country_locations <- function(data) {
  r <- data %>%
    filter(!startsWith(iso_code, 'OWID_')) %>%
    select(location, iso_code) %>%
    arrange(location)
  
  return (r)
}

get_all_special_locations <- function(data) {
  r <- data %>%
    filter(startsWith(iso_code, 'OWID_')) %>%
    select(location, iso_code) %>%
    arrange(location)
  
  return (r)
}
```

## Reading the data

Place the data within a folder called `data`. If downloading from the links
provided at the beginning of this document then file should already have the
correct name, else, rename it to `owid-covid-data.csv`. The data looks
pre-cleaned, which is nice. I may have to clean and up for certain activities
but I think it's better to do that just before visualization. If I end up
doing the same cleaning repeatedly I can just refactor. Refactoring is one of
the most useful skills a programmer can have and something greatly under used.

```{r reading-the-data}
raw_data <- read_csv("./data/owid-covid-data.csv")
typed_data <- apply_data_types(raw_data)
head(typed_data)
```

## Functions for amalgamating columns by time period

```{r functions-for-amalgamating-columns-by-time-period}
library("lubridate")

# These columns use the double type but some are actually integers.
# Later, it might be worth creating a metadata file with:
# - column_name (string)
# - type (string)
# - nullable (bool)
# - summable (bool)
# - aggregatable (bool)
# I might as well create metadata files for locations whilst I'm at it

aggregatable_cols <- c(
  "total_cases",
  "new_cases",
  "new_cases_smoothed",
  "total_deaths",
  "new_deaths",
  "new_deaths_smoothed",
  "total_cases_per_million",
  "new_cases_per_million",
  "new_cases_smoothed_per_million",
  "total_deaths_per_million",
  "new_deaths_per_million",
  "new_deaths_smoothed_per_million",
  "reproduction_rate",
  "icu_patients",
  "icu_patients_per_million",
  "hosp_patients",
  "hosp_patients_per_million",
  "weekly_icu_admissions",
  "weekly_icu_admissions_per_million",
  "weekly_hosp_admissions",
  "weekly_hosp_admissions_per_million",
  "total_tests",
  "new_tests",
  "total_tests_per_thousand",
  "new_tests_per_thousand",
  "new_tests_smoothed",
  "new_tests_smoothed_per_thousand",
  "positive_rate",
  "tests_per_case",
  "total_vaccinations",
  "people_vaccinated",
  "people_fully_vaccinated",
  "total_boosters",
  "new_vaccinations",
  "new_vaccinations_smoothed",
  "total_vaccinations_per_hundred",
  "people_vaccinated_per_hundred",
  "people_fully_vaccinated_per_hundred",
  "total_boosters_per_hundred",
  "new_vaccinations_smoothed_per_million",
  "new_people_vaccinated_smoothed",
  "new_people_vaccinated_smoothed_per_hundred",
  "stringency_index",
  "population",
  "population_density",
  "median_age",
  "aged_65_older",
  "aged_70_older",
  "gdp_per_capita",
  "extreme_poverty",
  "cardiovasc_death_rate",
  "diabetes_prevalence",
  "female_smokers",
  "male_smokers",
  "handwashing_facilities",
  "hospital_beds_per_thousand",
  "life_expectancy",
  "human_development_index",
  "excess_mortality_cumulative_absolute",
  "excess_mortality_cumulative",
  "excess_mortality",
  "excess_mortality_cumulative_per_million"
)

# TODO Some columns need to be removed.
# TODO Including `total_`s as I think they are cumulative 'to date'  
summable_cols <- c(
  "total_cases",
  "new_cases",
  "new_cases_smoothed",
  "total_deaths",
  "new_deaths",
  "new_deaths_smoothed",
  "total_cases_per_million",
  "new_cases_per_million",
  "new_cases_smoothed_per_million",
  "total_deaths_per_million",
  "new_deaths_per_million",
  "new_deaths_smoothed_per_million",
  "reproduction_rate",
  "icu_patients",
  "icu_patients_per_million",
  "hosp_patients",
  "hosp_patients_per_million",
  "weekly_icu_admissions",
  "weekly_icu_admissions_per_million",
  "weekly_hosp_admissions",
  "weekly_hosp_admissions_per_million",
  "total_tests",
  "new_tests",
  "total_tests_per_thousand",
  "new_tests_per_thousand",
  "new_tests_smoothed",
  "new_tests_smoothed_per_thousand",
  "positive_rate",
  "tests_per_case",
  "total_vaccinations",
  "people_vaccinated",
  "people_fully_vaccinated",
  "total_boosters",
  "new_vaccinations",
  "new_vaccinations_smoothed",
  "total_vaccinations_per_hundred",
  "people_vaccinated_per_hundred",
  "people_fully_vaccinated_per_hundred",
  "total_boosters_per_hundred",
  "new_vaccinations_smoothed_per_million",
  "new_people_vaccinated_smoothed",
  "new_people_vaccinated_smoothed_per_hundred",
  "stringency_index",
  "population",
  "population_density",
  "median_age",
  "aged_65_older",
  "aged_70_older",
  "gdp_per_capita",
  "extreme_poverty",
  "cardiovasc_death_rate",
  "diabetes_prevalence",
  "female_smokers",
  "male_smokers",
  "handwashing_facilities",
  "hospital_beds_per_thousand",
  "life_expectancy",
  "human_development_index",
  "excess_mortality_cumulative_absolute",
  "excess_mortality_cumulative",
  "excess_mortality",
  "excess_mortality_cumulative_per_million"
)

location_sum <- function(data) {
  r <- data %>%
    group_by(location) %>%
    summarise_at(summable_cols, sum, na.rm = TRUE) %>%
    ungroup() %>%
    arrange(location)
    
  return (r)
}

yearly_sum <- function(data) {
  r <- data %>%
    mutate(year = year(date)) %>%
    group_by(location, year) %>%
    summarise_at(summable_cols, sum, na.rm = TRUE) %>%
    ungroup() %>%
    arrange(location, year)
    
   return (r)
}

first_day_of_week = function(date) {
  return (as.Date(cut(date, "week")))
}

weekly_sum <- function(data) {
  start.on.monday = TRUE
  
  r <- data %>%
    mutate(week_start = first_day_of_week(date)) %>%
    group_by(location, week_start) %>%
    summarise_at(summable_cols, sum, na.rm = TRUE) %>%
    ungroup() %>%
    mutate(year = year(week_start)) %>% 
    mutate(week = week(week_start)) %>%  
    arrange(location, week_start)
    
   return (r)
}

#print(weekly_sum(typed_data))
```

## Visualising total cases to date in European countries

To get started I'm going to create a simple visualisation showing the number
of total cases in European countries. Nothing original, fancy, or particularly
useful by itself but got to start from pillars of strength.

```{r visualising-total-cases}
library("dplyr")
library("scales")

# TODO: Delete? Keep for reference?
unit_fmt_billions = unit_format(unit = "B", scale = ONE_NANO)

typed_data %>%
  filter(continent == "Europe") %>%
  location_sum() %>%
  select(location, total_cases) %>%
  filter(total_cases > ONE_HUNDRED_MILLION) %>%
  mutate(total_cases_in_billions = total_cases / ONE_BILLION) %>%
  ggplot() +
  geom_col(
    mapping = aes(
      x=reorder(location, desc(total_cases_in_billions)),
      y=total_cases_in_billions,
      fill=total_cases_in_billions,
    ),
  ) +
  scale_fill_gradient(low = "blue", high = "red") +
  apply_project_theme() +
  theme(
    axis.text.x = element_text(
      angle = 70,
      hjust = 1,
      margin = margin(0,0,0,0),
      colour = "black",
    ),
    axis.title.x = element_blank(),
    panel.grid.major.y = thin_line_style,
  ) +
  labs(
    title="Cumulative Covid cases in European countries",
    subtitle="Where total cases > 100 Million",
    y="Total cases (US Billions)",
  )

save_plot("cumulative-covid-cases-in-european-countries.jpeg")
```

## UK Covid cases peeked during the winter of 2022

```{r visualising-total-cases}
library("dplyr")
library("ggplot2")
library("scales")
library("zoo")

plot_data <- typed_data %>%
  weekly_sum() %>%
  filter(
    location == "United Kingdom",
  ) %>%
  select(
    week_start,
    new_cases,
    hosp_patients,
    icu_patients,
  ) %>%
  # mutate(
  #   year_week = str_pad(week, 2, pad = "0"),
  #   year_week = paste(year, year_week, sep="-"),
  # ) %>%
  mutate(
    new_cases_in_millions = new_cases / ONE_MILLION,
    hosp_patients_in_millions = hosp_patients / ONE_MILLION,
  ) %>%
  arrange(week_start) %>%
  print()

ggplot(
  data = plot_data,
  mapping = aes(
    x = week_start,
    width = 8,
  ),
) +
geom_col(
  mapping = aes(
    y = new_cases_in_millions,
    fill = new_cases_in_millions,
  ),
) +
scale_fill_gradient(low = "blue", high = "orange") +
scale_x_date(date_labels = "%Y", date_breaks = "1 year") +
apply_project_theme() +
theme(
  axis.title.x = element_blank(),
) +
labs(
  title="UK reported Covid cases peeked during the winter of 2022",
  y="New cases in the UK (Millions)",
)

save_plot("weekly-new-cases-in-the-uk.jpeg")
```